<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>로컬푸드 당일배송 - 경산온(ON)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Pretendard", "Apple SD Gothic Neo", "Noto Sans KR", sans-serif;
        }
        .harvest-badge {
            background: linear-gradient(135deg, #34d399 0%, #10b981 100%);
            animation: shine 3s ease-in-out infinite;
        }
        @keyframes shine {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.9; }
        }
        .product-card {
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .product-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 16px rgba(0,0,0,0.1);
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            animation: fadeIn 0.3s;
        }
        .modal.active {
            display: flex;
            align-items: flex-end;
            justify-content: center;
        }
        .modal-content {
            background: white;
            padding: 24px;
            border-radius: 24px 24px 0 0;
            width: 100%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            animation: slideUp 0.3s;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @keyframes slideUp {
            from { transform: translateY(100%); }
            to { transform: translateY(0); }
        }
        .certification-badge {
            font-size: 10px;
            padding: 2px 6px;
        }
        .quantity-selector button {
            width: 40px;
            height: 40px;
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- 헤더 -->
    <header class="bg-white shadow-sm sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-2">
                    <a href="/" class="text-2xl font-bold text-[#1F3A5F]">
                        경산온(ON)
                    </a>
                    <span class="text-sm text-gray-500">로컬푸드</span>
                </div>
                <a href="/" class="text-gray-600 hover:text-gray-900">
                    <i class="fas fa-home text-xl"></i>
                </a>
            </div>
        </div>
    </header>

    <!-- 당일수확 안내 배너 -->
    <div class="harvest-badge text-white py-3 px-4 text-center">
        <i class="fas fa-leaf mr-2"></i>
        <strong>당일 수확 당일 배송</strong> - 오늘 수확한 신선한 농산물을 오늘/내일 받아보세요!
    </div>

    <!-- 카테고리 필터 -->
    <div class="bg-white border-b">
        <div class="max-w-7xl mx-auto px-4">
            <div class="flex space-x-2 overflow-x-auto py-3">
                <button class="filter-btn active px-4 py-2 rounded-full text-sm font-medium whitespace-nowrap" data-category="all">
                    전체
                </button>
                <button class="filter-btn px-4 py-2 rounded-full text-sm font-medium whitespace-nowrap" data-category="채소">
                    <i class="fas fa-carrot mr-1"></i> 채소
                </button>
                <button class="filter-btn px-4 py-2 rounded-full text-sm font-medium whitespace-nowrap" data-category="과일">
                    <i class="fas fa-apple-alt mr-1"></i> 과일
                </button>
                <button class="filter-btn px-4 py-2 rounded-full text-sm font-medium whitespace-nowrap" data-category="특산물">
                    <i class="fas fa-star mr-1"></i> 특산물
                </button>
            </div>
        </div>
    </div>

    <!-- 상품 목록 -->
    <main class="max-w-7xl mx-auto px-4 py-6">
        <div class="mb-4">
            <h2 class="text-lg font-bold text-gray-900 mb-2">
                <i class="fas fa-seedling text-green-600 mr-2"></i>
                오늘 수확한 신선한 농산물
            </h2>
            <p class="text-sm text-gray-600">
                생산자와 직거래로 신선함은 UP, 가격은 DOWN!
            </p>
        </div>

        <div id="productsGrid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
            <!-- 동적 로딩 -->
        </div>
    </main>

    <!-- 예약 주문 모달 (바텀시트) -->
    <div id="orderModal" class="modal">
        <div class="modal-content">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-xl font-bold text-gray-900">
                    <i class="fas fa-shopping-basket text-green-600 mr-2"></i>
                    예약 주문하기
                </h3>
                <button onclick="closeOrderModal()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>

            <!-- 안내 메시지 -->
            <div class="bg-green-50 border border-green-200 rounded-lg p-4 mb-4">
                <p class="text-sm text-green-800">
                    <i class="fas fa-info-circle mr-2"></i>
                    <strong>당일 수확 시스템</strong><br>
                    오늘 수확한 농산물을 선택하신 배송일에 받아보실 수 있습니다.
                </p>
            </div>

            <div id="orderContent">
                <!-- 동적 로딩 -->
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/axios@1.6.0/dist/axios.min.js"></script>
    <script>
        let allProducts = [];
        let currentCategory = 'all';
        let selectedProduct = null;
        let orderQuantity = 1;

        // 페이지 로드 시 데이터 가져오기
        async function loadProducts() {
            try {
                const response = await axios.get('/api/local-food-products');
                allProducts = response.data.products || [];
                renderProducts();
            } catch (error) {
                console.error('상품 로딩 실패:', error);
                document.getElementById('productsGrid').innerHTML = `
                    <div class="col-span-full text-center py-12 text-gray-500">
                        <i class="fas fa-exclamation-circle text-4xl mb-4"></i>
                        <p>상품을 불러오는데 실패했습니다.</p>
                    </div>
                `;
            }
        }

        // 상품 렌더링
        function renderProducts() {
            const filtered = currentCategory === 'all' 
                ? allProducts 
                : allProducts.filter(p => p.category === currentCategory);

            const grid = document.getElementById('productsGrid');
            
            if (filtered.length === 0) {
                grid.innerHTML = `
                    <div class="col-span-full text-center py-12 text-gray-500">
                        <i class="fas fa-box-open text-4xl mb-4"></i>
                        <p>등록된 상품이 없습니다.</p>
                    </div>
                `;
                return;
            }

            grid.innerHTML = filtered.map(product => `
                <div class="product-card bg-white rounded-lg shadow-sm overflow-hidden cursor-pointer" onclick="openOrderModal('${product.productId}')">
                    <div class="relative pb-[75%] bg-gray-200">
                        <img src="${product.thumbnail || 'https://via.placeholder.com/300x200?text=Fresh+Food'}" 
                             alt="${product.productName}"
                             class="absolute inset-0 w-full h-full object-cover">
                        <span class="harvest-badge absolute top-2 left-2 text-white text-xs px-2 py-1 rounded-full font-bold">
                            <i class="fas fa-leaf mr-1"></i> 당일수확
                        </span>
                        ${getCertificationBadge(product.certification)}
                    </div>
                    <div class="p-3">
                        <h4 class="font-medium text-gray-900 mb-1 line-clamp-2">${product.productName}</h4>
                        <p class="text-sm text-gray-600 mb-2">
                            <i class="fas fa-user-farmer mr-1"></i>${product.farmerName}
                        </p>
                        <div class="flex items-center justify-between">
                            <span class="text-lg font-bold text-gray-900">
                                ${product.price.toLocaleString()}원
                            </span>
                            <span class="text-xs text-gray-500">${product.unit}</span>
                        </div>
                        <div class="mt-2 flex items-center justify-between text-xs">
                            <span class="text-green-600">
                                <i class="fas fa-box mr-1"></i>재고 ${product.todayStock}${product.unit}
                            </span>
                            <span class="text-gray-500">
                                <i class="fas fa-calendar mr-1"></i>${formatDate(product.harvestDate)}
                            </span>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // 필터 버튼 이벤트
        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('.filter-btn').forEach(b => {
                    b.classList.remove('active', 'bg-green-600', 'text-white');
                    b.classList.add('bg-gray-100', 'text-gray-600');
                });
                this.classList.add('active', 'bg-green-600', 'text-white');
                this.classList.remove('bg-gray-100', 'text-gray-600');
                
                currentCategory = this.dataset.category;
                renderProducts();
            });
        });

        // 초기 필터 스타일
        document.querySelector('.filter-btn.active').classList.add('bg-green-600', 'text-white');
        document.querySelectorAll('.filter-btn:not(.active)').forEach(btn => {
            btn.classList.add('bg-gray-100', 'text-gray-600');
        });

        // 예약 주문 모달 열기
        function openOrderModal(productId) {
            selectedProduct = allProducts.find(p => p.productId === productId);
            if (!selectedProduct) return;

            orderQuantity = 1;
            const modal = document.getElementById('orderModal');
            const content = document.getElementById('orderContent');

            content.innerHTML = `
                <!-- 상품 정보 -->
                <div class="bg-gray-50 rounded-lg p-4 mb-4">
                    <div class="flex items-start space-x-3">
                        <img src="${selectedProduct.thumbnail || 'https://via.placeholder.com/80x80?text=Food'}" 
                             alt="${selectedProduct.productName}"
                             class="w-20 h-20 rounded-lg object-cover">
                        <div class="flex-1">
                            <h4 class="font-bold text-gray-900 mb-1">${selectedProduct.productName}</h4>
                            <p class="text-sm text-gray-600 mb-1">
                                <i class="fas fa-user-farmer mr-1"></i>${selectedProduct.farmerName} (${selectedProduct.farmName})
                            </p>
                            <p class="text-sm text-green-600">
                                <i class="fas fa-calendar-check mr-1"></i>수확일: ${formatDate(selectedProduct.harvestDate)}
                            </p>
                        </div>
                    </div>
                </div>

                <!-- 수량 선택 -->
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fas fa-shopping-basket mr-1"></i>
                        수량 선택
                        <span class="text-green-600 ml-2">(최대 ${selectedProduct.todayStock}${selectedProduct.unit})</span>
                    </label>
                    <div class="quantity-selector flex items-center justify-center space-x-4">
                        <button onclick="decreaseQuantity()" 
                                class="bg-gray-200 hover:bg-gray-300 rounded-full font-bold text-gray-700">
                            <i class="fas fa-minus"></i>
                        </button>
                        <span id="quantityDisplay" class="text-2xl font-bold text-gray-900 min-w-[60px] text-center">
                            1
                        </span>
                        <button onclick="increaseQuantity()" 
                                class="bg-green-600 hover:bg-green-700 text-white rounded-full font-bold">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                </div>

                <!-- 배송일 선택 -->
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fas fa-truck mr-1"></i>
                        배송일 선택
                    </label>
                    <div class="grid grid-cols-2 gap-3">
                        <label class="relative">
                            <input type="radio" name="deliveryDate" value="today" checked
                                   class="peer sr-only">
                            <div class="border-2 border-gray-300 peer-checked:border-green-600 peer-checked:bg-green-50 rounded-lg p-4 cursor-pointer text-center">
                                <div class="font-bold text-gray-900 mb-1">오늘 저녁</div>
                                <div class="text-xs text-gray-600">18:00-20:00</div>
                            </div>
                        </label>
                        <label class="relative">
                            <input type="radio" name="deliveryDate" value="tomorrow"
                                   class="peer sr-only">
                            <div class="border-2 border-gray-300 peer-checked:border-green-600 peer-checked:bg-green-50 rounded-lg p-4 cursor-pointer text-center">
                                <div class="font-bold text-gray-900 mb-1">내일 오전</div>
                                <div class="text-xs text-gray-600">09:00-12:00</div>
                            </div>
                        </label>
                    </div>
                </div>

                <!-- 주문 요약 -->
                <div class="bg-gray-50 rounded-lg p-4 mb-6">
                    <div class="flex justify-between mb-2">
                        <span class="text-gray-700">상품 금액</span>
                        <span id="productTotal" class="font-medium">${selectedProduct.price.toLocaleString()}원</span>
                    </div>
                    <div class="flex justify-between mb-2">
                        <span class="text-gray-700">배송비</span>
                        <span class="font-medium text-green-600">0원 (무료배송)</span>
                    </div>
                    <div class="border-t pt-2 mt-2 flex justify-between">
                        <span class="font-bold text-gray-900">총 결제금액</span>
                        <span id="totalPrice" class="font-bold text-xl text-green-600">${selectedProduct.price.toLocaleString()}원</span>
                    </div>
                </div>

                <!-- 무료배송 안내 -->
                <div class="bg-green-50 border border-green-200 rounded-lg p-3 mb-4">
                    <p class="text-sm text-green-800">
                        <i class="fas fa-truck mr-2"></i>
                        <strong>로컬푸드 직거래 지원</strong> - 배송비 0원
                    </p>
                </div>

                <!-- 주문 버튼 -->
                <button onclick="submitOrder()" 
                        class="w-full bg-green-600 hover:bg-green-700 text-white py-4 px-4 rounded-lg font-bold text-lg">
                    <i class="fas fa-check-circle mr-2"></i>
                    ${selectedProduct.price.toLocaleString()}원 예약 주문하기
                </button>
            `;

            modal.classList.add('active');
        }

        function closeOrderModal() {
            document.getElementById('orderModal').classList.remove('active');
            selectedProduct = null;
            orderQuantity = 1;
        }

        function increaseQuantity() {
            if (orderQuantity < selectedProduct.todayStock) {
                orderQuantity++;
                updateQuantityDisplay();
            } else {
                alert(`최대 ${selectedProduct.todayStock}${selectedProduct.unit}까지만 주문 가능합니다.`);
            }
        }

        function decreaseQuantity() {
            if (orderQuantity > 1) {
                orderQuantity--;
                updateQuantityDisplay();
            }
        }

        function updateQuantityDisplay() {
            document.getElementById('quantityDisplay').textContent = orderQuantity;
            const productTotal = selectedProduct.price * orderQuantity;
            document.getElementById('productTotal').textContent = productTotal.toLocaleString() + '원';
            document.getElementById('totalPrice').textContent = productTotal.toLocaleString() + '원';
            
            // 버튼 텍스트도 업데이트
            const submitBtn = document.querySelector('button[onclick="submitOrder()"]');
            submitBtn.innerHTML = `
                <i class="fas fa-check-circle mr-2"></i>
                ${productTotal.toLocaleString()}원 예약 주문하기
            `;
        }

        async function submitOrder() {
            const deliveryDate = document.querySelector('input[name="deliveryDate"]:checked').value;
            
            try {
                const orderData = {
                    productId: selectedProduct.productId,
                    farmId: selectedProduct.farmId,
                    quantity: orderQuantity,
                    deliveryDate: deliveryDate,
                    totalPrice: selectedProduct.price * orderQuantity
                };

                const response = await axios.post('/api/local-food-orders', orderData);
                
                alert(`✅ 예약 주문이 완료되었습니다!\n\n상품: ${selectedProduct.productName}\n수량: ${orderQuantity}${selectedProduct.unit}\n배송: ${deliveryDate === 'today' ? '오늘 저녁' : '내일 오전'}\n총 금액: ${(selectedProduct.price * orderQuantity).toLocaleString()}원`);
                
                closeOrderModal();
                loadProducts(); // 재고 업데이트
            } catch (error) {
                console.error('주문 실패:', error);
                alert('주문에 실패했습니다. 다시 시도해주세요.');
            }
        }

        function getCertificationBadge(cert) {
            const badges = {
                'ORGANIC': '<span class="certification-badge absolute top-2 right-2 bg-green-600 text-white px-2 py-1 rounded-full font-bold">유기농</span>',
                'PESTICIDE_FREE': '<span class="certification-badge absolute top-2 right-2 bg-blue-600 text-white px-2 py-1 rounded-full font-bold">무농약</span>',
                'LOCAL': '<span class="certification-badge absolute top-2 right-2 bg-purple-600 text-white px-2 py-1 rounded-full font-bold">지역농산물</span>'
            };
            return badges[cert] || '';
        }

        function formatDate(dateStr) {
            const date = new Date(dateStr);
            const today = new Date();
            
            if (date.toDateString() === today.toDateString()) {
                return '오늘';
            }
            
            const month = date.getMonth() + 1;
            const day = date.getDate();
            return `${month}월 ${day}일`;
        }

        // 페이지 로드
        loadProducts();
    </script>
</body>
</html>
