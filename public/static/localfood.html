<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë¡œì»¬í‘¸ë“œ ë‹¹ì¼ë°°ì†¡ - ê²½ì‚°ì˜¨(ON)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Pretendard", "Apple SD Gothic Neo", "Noto Sans KR", sans-serif;
        }
        .harvest-badge {
            background: linear-gradient(135deg, #34d399 0%, #10b981 100%);
            animation: shine 3s ease-in-out infinite;
        }
        @keyframes shine {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.9; }
        }
        .product-card {
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .product-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 16px rgba(0,0,0,0.1);
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            animation: fadeIn 0.3s;
        }
        .modal.active {
            display: flex;
            align-items: flex-end;
            justify-content: center;
        }
        .modal-content {
            background: white;
            padding: 24px;
            border-radius: 24px 24px 0 0;
            width: 100%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            animation: slideUp 0.3s;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @keyframes slideUp {
            from { transform: translateY(100%); }
            to { transform: translateY(0); }
        }
        .certification-badge {
            font-size: 10px;
            padding: 2px 6px;
        }
        .quantity-selector button {
            width: 40px;
            height: 40px;
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- í—¤ë” -->
    <header class="bg-white shadow-sm sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-2">
                    <a href="/" class="text-2xl font-bold text-[#1F3A5F]">
                        ê²½ì‚°ì˜¨(ON)
                    </a>
                    <span class="text-sm text-gray-500">ë¡œì»¬í‘¸ë“œ</span>
                </div>
                <a href="/" class="text-gray-600 hover:text-gray-900">
                    <i class="fas fa-home text-xl"></i>
                </a>
            </div>
        </div>
    </header>

    <!-- ë‹¹ì¼ìˆ˜í™• ì•ˆë‚´ ë°°ë„ˆ -->
    <div class="harvest-badge text-white py-3 px-4 text-center">
        <i class="fas fa-leaf mr-2"></i>
        <strong>ë‹¹ì¼ ìˆ˜í™• ë‹¹ì¼ ë°°ì†¡</strong> - ì˜¤ëŠ˜ ìˆ˜í™•í•œ ì‹ ì„ í•œ ë†ì‚°ë¬¼ì„ ì˜¤ëŠ˜/ë‚´ì¼ ë°›ì•„ë³´ì„¸ìš”!
    </div>

    <!-- ì¹´í…Œê³ ë¦¬ í•„í„° -->
    <div class="bg-white border-b">
        <div class="max-w-7xl mx-auto px-4">
            <div class="flex space-x-2 overflow-x-auto py-3">
                <button class="filter-btn active px-4 py-2 rounded-full text-sm font-medium whitespace-nowrap" data-category="all">
                    ì „ì²´
                </button>
                <button class="filter-btn px-4 py-2 rounded-full text-sm font-medium whitespace-nowrap" data-category="ì±„ì†Œ">
                    <i class="fas fa-carrot mr-1"></i> ì±„ì†Œ
                </button>
                <button class="filter-btn px-4 py-2 rounded-full text-sm font-medium whitespace-nowrap" data-category="ê³¼ì¼">
                    <i class="fas fa-apple-alt mr-1"></i> ê³¼ì¼
                </button>
                <button class="filter-btn px-4 py-2 rounded-full text-sm font-medium whitespace-nowrap" data-category="íŠ¹ì‚°ë¬¼">
                    <i class="fas fa-star mr-1"></i> íŠ¹ì‚°ë¬¼
                </button>
            </div>
        </div>
    </div>

    <!-- ìƒí’ˆ ëª©ë¡ -->
    <main class="max-w-7xl mx-auto px-4 py-6">
        <div class="mb-4">
            <h2 class="text-lg font-bold text-gray-900 mb-2">
                <i class="fas fa-seedling text-green-600 mr-2"></i>
                ì˜¤ëŠ˜ ìˆ˜í™•í•œ ì‹ ì„ í•œ ë†ì‚°ë¬¼
            </h2>
            <p class="text-sm text-gray-600">
                ìƒì‚°ìì™€ ì§ê±°ë˜ë¡œ ì‹ ì„ í•¨ì€ UP, ê°€ê²©ì€ DOWN!
            </p>
        </div>

        <div id="productsGrid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
            <!-- ë™ì  ë¡œë”© -->
        </div>
    </main>

    <!-- ì˜ˆì•½ ì£¼ë¬¸ ëª¨ë‹¬ (ë°”í…€ì‹œíŠ¸) -->
    <div id="orderModal" class="modal">
        <div class="modal-content">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-xl font-bold text-gray-900">
                    <i class="fas fa-shopping-basket text-green-600 mr-2"></i>
                    ì˜ˆì•½ ì£¼ë¬¸í•˜ê¸°
                </h3>
                <button onclick="closeOrderModal()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>

            <!-- ì•ˆë‚´ ë©”ì‹œì§€ -->
            <div class="bg-green-50 border border-green-200 rounded-lg p-4 mb-4">
                <p class="text-sm text-green-800">
                    <i class="fas fa-info-circle mr-2"></i>
                    <strong>ë‹¹ì¼ ìˆ˜í™• ì‹œìŠ¤í…œ</strong><br>
                    ì˜¤ëŠ˜ ìˆ˜í™•í•œ ë†ì‚°ë¬¼ì„ ì„ íƒí•˜ì‹  ë°°ì†¡ì¼ì— ë°›ì•„ë³´ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                </p>
            </div>

            <div id="orderContent">
                <!-- ë™ì  ë¡œë”© -->
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/axios@1.6.0/dist/axios.min.js"></script>
    <script>
        let allProducts = [];
        let currentCategory = 'all';
        let selectedProduct = null;
        let orderQuantity = 1;

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
        async function loadProducts() {
            try {
                const response = await axios.get('/api/local-food-products');
                allProducts = response.data.products || [];
                renderProducts();
            } catch (error) {
                console.error('ìƒí’ˆ ë¡œë”© ì‹¤íŒ¨:', error);
                document.getElementById('productsGrid').innerHTML = `
                    <div class="col-span-full text-center py-12 text-gray-500">
                        <i class="fas fa-exclamation-circle text-4xl mb-4"></i>
                        <p>ìƒí’ˆì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</p>
                    </div>
                `;
            }
        }

        // ìƒí’ˆ ë Œë”ë§
        function renderProducts() {
            const filtered = currentCategory === 'all' 
                ? allProducts 
                : allProducts.filter(p => p.category === currentCategory);

            const grid = document.getElementById('productsGrid');
            
            if (filtered.length === 0) {
                grid.innerHTML = `
                    <div class="col-span-full text-center py-12 text-gray-500">
                        <i class="fas fa-box-open text-4xl mb-4"></i>
                        <p>ë“±ë¡ëœ ìƒí’ˆì´ ì—†ìŠµë‹ˆë‹¤.</p>
                    </div>
                `;
                return;
            }

            grid.innerHTML = filtered.map(product => `
                <div class="product-card bg-white rounded-lg shadow-sm overflow-hidden cursor-pointer" onclick="openOrderModal('${product.productId}')">
                    <div class="relative h-48 bg-gray-200">
                        <img src="${product.thumbnail || 'https://via.placeholder.com/400x300?text=Fresh+Food'}" 
                             alt="${product.productName}"
                             class="w-full h-full object-cover">
                        <span class="harvest-badge absolute top-2 left-2 text-white text-xs px-2 py-1 rounded-full font-bold">
                            <i class="fas fa-leaf mr-1"></i> ë‹¹ì¼ìˆ˜í™•
                        </span>
                        ${getCertificationBadge(product.certification)}
                    </div>
                    <div class="p-3">
                        <h4 class="font-medium text-gray-900 mb-1 line-clamp-2">${product.productName}</h4>
                        <p class="text-sm text-gray-600 mb-2">
                            <i class="fas fa-user-farmer mr-1"></i>${product.farmerName}
                        </p>
                        <div class="flex items-center justify-between">
                            <span class="text-lg font-bold text-gray-900">
                                ${product.price.toLocaleString()}ì›
                            </span>
                            <span class="text-xs text-gray-500">${product.unit}</span>
                        </div>
                        <div class="mt-2 flex items-center justify-between text-xs">
                            <span class="text-green-600">
                                <i class="fas fa-box mr-1"></i>ì¬ê³  ${product.todayStock}${product.unit}
                            </span>
                            <span class="text-gray-500">
                                <i class="fas fa-calendar mr-1"></i>${formatDate(product.harvestDate)}
                            </span>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // í•„í„° ë²„íŠ¼ ì´ë²¤íŠ¸
        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('.filter-btn').forEach(b => {
                    b.classList.remove('active', 'bg-green-600', 'text-white');
                    b.classList.add('bg-gray-100', 'text-gray-600');
                });
                this.classList.add('active', 'bg-green-600', 'text-white');
                this.classList.remove('bg-gray-100', 'text-gray-600');
                
                currentCategory = this.dataset.category;
                renderProducts();
            });
        });

        // ì´ˆê¸° í•„í„° ìŠ¤íƒ€ì¼
        document.querySelector('.filter-btn.active').classList.add('bg-green-600', 'text-white');
        document.querySelectorAll('.filter-btn:not(.active)').forEach(btn => {
            btn.classList.add('bg-gray-100', 'text-gray-600');
        });

        // ì˜ˆì•½ ì£¼ë¬¸ ëª¨ë‹¬ ì—´ê¸°
        function openOrderModal(productId) {
            selectedProduct = allProducts.find(p => p.productId === productId);
            if (!selectedProduct) return;

            orderQuantity = 1;
            const modal = document.getElementById('orderModal');
            const content = document.getElementById('orderContent');

            content.innerHTML = `
                <!-- ìƒí’ˆ ì •ë³´ -->
                <div class="bg-gray-50 rounded-lg p-4 mb-4">
                    <div class="mb-3">
                        <img src="${selectedProduct.thumbnail || 'https://via.placeholder.com/400x300?text=Food'}" 
                             alt="${selectedProduct.productName}"
                             class="w-full h-48 rounded-lg object-cover">
                    </div>
                    <div>
                        <h4 class="font-bold text-gray-900 mb-2 text-lg">${selectedProduct.productName}</h4>
                        <p class="text-sm text-gray-600 mb-1">
                            <i class="fas fa-user-farmer mr-1"></i>${selectedProduct.farmerName} (${selectedProduct.farmName})
                        </p>
                        <p class="text-sm text-green-600">
                            <i class="fas fa-calendar-check mr-1"></i>ìˆ˜í™•ì¼: ${formatDate(selectedProduct.harvestDate)}
                        </p>
                    </div>
                </div>

                <!-- ìˆ˜ëŸ‰ ì„ íƒ -->
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fas fa-shopping-basket mr-1"></i>
                        ìˆ˜ëŸ‰ ì„ íƒ
                        <span class="text-green-600 ml-2">(ìµœëŒ€ ${selectedProduct.todayStock}${selectedProduct.unit})</span>
                    </label>
                    <div class="quantity-selector flex items-center justify-center space-x-4">
                        <button onclick="decreaseQuantity()" 
                                class="bg-gray-200 hover:bg-gray-300 rounded-full font-bold text-gray-700">
                            <i class="fas fa-minus"></i>
                        </button>
                        <span id="quantityDisplay" class="text-2xl font-bold text-gray-900 min-w-[60px] text-center">
                            1
                        </span>
                        <button onclick="increaseQuantity()" 
                                class="bg-green-600 hover:bg-green-700 text-white rounded-full font-bold">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                </div>

                <!-- ë°°ì†¡ì¼ ì„ íƒ -->
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fas fa-truck mr-1"></i>
                        ë°°ì†¡ì¼ ì„ íƒ
                    </label>
                    <div class="grid grid-cols-2 gap-3">
                        <label class="relative">
                            <input type="radio" name="deliveryDate" value="today" checked
                                   class="peer sr-only">
                            <div class="border-2 border-gray-300 peer-checked:border-green-600 peer-checked:bg-green-50 rounded-lg p-4 cursor-pointer text-center">
                                <div class="font-bold text-gray-900 mb-1">ì˜¤ëŠ˜ ì €ë…</div>
                                <div class="text-xs text-gray-600">18:00-20:00</div>
                            </div>
                        </label>
                        <label class="relative">
                            <input type="radio" name="deliveryDate" value="tomorrow"
                                   class="peer sr-only">
                            <div class="border-2 border-gray-300 peer-checked:border-green-600 peer-checked:bg-green-50 rounded-lg p-4 cursor-pointer text-center">
                                <div class="font-bold text-gray-900 mb-1">ë‚´ì¼ ì˜¤ì „</div>
                                <div class="text-xs text-gray-600">09:00-12:00</div>
                            </div>
                        </label>
                    </div>
                </div>

                <!-- ì£¼ë¬¸ ìš”ì•½ -->
                <div class="bg-gray-50 rounded-lg p-4 mb-6">
                    <div class="flex justify-between mb-2">
                        <span class="text-gray-700">ìƒí’ˆ ê¸ˆì•¡</span>
                        <span id="productTotal" class="font-medium">${selectedProduct.price.toLocaleString()}ì›</span>
                    </div>
                    <div class="flex justify-between mb-2">
                        <span class="text-gray-700">ë°°ì†¡ë¹„</span>
                        <span class="font-medium text-green-600">0ì› (ë¬´ë£Œë°°ì†¡)</span>
                    </div>
                    <div class="border-t pt-2 mt-2 flex justify-between">
                        <span class="font-bold text-gray-900">ì´ ê²°ì œê¸ˆì•¡</span>
                        <span id="totalPrice" class="font-bold text-xl text-green-600">${selectedProduct.price.toLocaleString()}ì›</span>
                    </div>
                </div>

                <!-- ë¬´ë£Œë°°ì†¡ ì•ˆë‚´ -->
                <div class="bg-green-50 border border-green-200 rounded-lg p-3 mb-4">
                    <p class="text-sm text-green-800">
                        <i class="fas fa-truck mr-2"></i>
                        <strong>ë¡œì»¬í‘¸ë“œ ì§ê±°ë˜ ì§€ì›</strong> - ë°°ì†¡ë¹„ 0ì›
                    </p>
                </div>

                <!-- ì£¼ë¬¸ ë²„íŠ¼ -->
                <button onclick="submitOrder()" 
                        class="w-full bg-green-600 hover:bg-green-700 text-white py-4 px-4 rounded-lg font-bold text-lg">
                    <i class="fas fa-check-circle mr-2"></i>
                    ${selectedProduct.price.toLocaleString()}ì› ì˜ˆì•½ ì£¼ë¬¸í•˜ê¸°
                </button>
            `;

            modal.classList.add('active');
        }

        function closeOrderModal() {
            document.getElementById('orderModal').classList.remove('active');
            selectedProduct = null;
            orderQuantity = 1;
        }

        function increaseQuantity() {
            if (orderQuantity < selectedProduct.todayStock) {
                orderQuantity++;
                updateQuantityDisplay();
            } else {
                alert(`ìµœëŒ€ ${selectedProduct.todayStock}${selectedProduct.unit}ê¹Œì§€ë§Œ ì£¼ë¬¸ ê°€ëŠ¥í•©ë‹ˆë‹¤.`);
            }
        }

        function decreaseQuantity() {
            if (orderQuantity > 1) {
                orderQuantity--;
                updateQuantityDisplay();
            }
        }

        function updateQuantityDisplay() {
            document.getElementById('quantityDisplay').textContent = orderQuantity;
            const productTotal = selectedProduct.price * orderQuantity;
            document.getElementById('productTotal').textContent = productTotal.toLocaleString() + 'ì›';
            document.getElementById('totalPrice').textContent = productTotal.toLocaleString() + 'ì›';
            
            // ë²„íŠ¼ í…ìŠ¤íŠ¸ë„ ì—…ë°ì´íŠ¸
            const submitBtn = document.querySelector('button[onclick="submitOrder()"]');
            submitBtn.innerHTML = `
                <i class="fas fa-check-circle mr-2"></i>
                ${productTotal.toLocaleString()}ì› ì˜ˆì•½ ì£¼ë¬¸í•˜ê¸°
            `;
        }

        async function submitOrder() {
            const deliveryDate = document.querySelector('input[name="deliveryDate"]:checked').value;
            
            try {
                // 1ï¸âƒ£ ì¥ë°”êµ¬ë‹ˆì— ìƒí’ˆ ì¶”ê°€ (localStorage)
                const product = {
                    id: selectedProduct.productId,
                    type: 'localfood',
                    name: selectedProduct.productName,
                    price: selectedProduct.price,
                    quantity: orderQuantity,
                    unit: selectedProduct.unit,
                    deliveryDate: deliveryDate,
                    farmName: selectedProduct.farmName,
                    certification: selectedProduct.certification,
                    addedAt: new Date().toISOString()
                };

                let cart = JSON.parse(localStorage.getItem('cart')) || [];
                cart.push(product);
                localStorage.setItem('cart', JSON.stringify(cart));

                // 2ï¸âƒ£ ì„œë²„ì— ì£¼ë¬¸ ì „ì†¡
                const orderData = {
                    productId: selectedProduct.productId,
                    farmId: selectedProduct.farmId,
                    quantity: orderQuantity,
                    deliveryDate: deliveryDate,
                    totalPrice: selectedProduct.price * orderQuantity
                };

                const response = await axios.post('/api/local-food-orders', orderData);
                
                // 3ï¸âƒ£ ì‚¬ìš©ì í”¼ë“œë°±
                alert(`âœ… ì¥ë°”êµ¬ë‹ˆì— ë‹´ê²¼ìŠµë‹ˆë‹¤!\n\nìƒí’ˆ: ${selectedProduct.productName}\nìˆ˜ëŸ‰: ${orderQuantity}${selectedProduct.unit}\në°°ì†¡: ${deliveryDate === 'today' ? 'ì˜¤ëŠ˜ ì €ë…' : 'ë‚´ì¼ ì˜¤ì „'}\nì´ ê¸ˆì•¡: ${(selectedProduct.price * orderQuantity).toLocaleString()}ì›\n\nì¥ë°”êµ¬ë‹ˆ: ${cart.length}ê°œ ìƒí’ˆ`);
                
                console.log('ğŸ›’ í˜„ì¬ ì¥ë°”êµ¬ë‹ˆ:', cart);
                
                closeOrderModal();
                loadProducts(); // ì¬ê³  ì—…ë°ì´íŠ¸
                
                // 4ï¸âƒ£ (ì„ íƒ) ì£¼ë¬¸ í˜ì´ì§€ë¡œ ì´ë™í•˜ì‹œê² ìŠµë‹ˆê¹Œ?
                // if (confirm('ì£¼ë¬¸ í˜ì´ì§€ë¡œ ì´ë™í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                //     window.location.href = '/order';
                // }
            } catch (error) {
                console.error('ì£¼ë¬¸ ì‹¤íŒ¨:', error);
                alert('ì¥ë°”êµ¬ë‹ˆ ë‹´ê¸°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
            }
        }

        function getCertificationBadge(cert) {
            const badges = {
                'ORGANIC': '<span class="certification-badge absolute top-2 right-2 bg-green-600 text-white px-2 py-1 rounded-full font-bold">ìœ ê¸°ë†</span>',
                'PESTICIDE_FREE': '<span class="certification-badge absolute top-2 right-2 bg-blue-600 text-white px-2 py-1 rounded-full font-bold">ë¬´ë†ì•½</span>',
                'LOCAL': '<span class="certification-badge absolute top-2 right-2 bg-purple-600 text-white px-2 py-1 rounded-full font-bold">ì§€ì—­ë†ì‚°ë¬¼</span>'
            };
            return badges[cert] || '';
        }

        function formatDate(dateStr) {
            const date = new Date(dateStr);
            const today = new Date();
            
            if (date.toDateString() === today.toDateString()) {
                return 'ì˜¤ëŠ˜';
            }
            
            const month = date.getMonth() + 1;
            const day = date.getDate();
            return `${month}ì›” ${day}ì¼`;
        }

        // í˜ì´ì§€ ë¡œë“œ
        loadProducts();
    </script>
</body>
</html>
